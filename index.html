<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Good Morning Challenge</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Bubbles&family=ZCOOL+KuaiLe&family=Zen+Maru+Gothic:wght@500;700&family=Yomogi&family=Potta+One&family=Dela+Gothic+One&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --ghibli-sky: #A1D2EB;
            --ghibli-sun: #F4EBC1;
            --ghibli-earth: #8B5E3C;
            --ghibli-cream: #FFFBE8;
            --text-dark: #4A3B2F;
            
            --font-main: 'ZCOOL KuaiLe', cursive; 
            --font-en: 'Rubik Bubbles', cursive; 
        }

        body {
            font-family: var(--font-main);
            color: var(--text-dark);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));

            background-color: var(--ghibli-sky);
            background-image: url('cat.png'); 
            background-size: 180px auto; 
            background-repeat: repeat;
            background-position: center top; 
            background-attachment: fixed; 
            background-blend-mode: multiply;
        }

        header { 
            width: 100%; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center;
        }

        .header-top-row {
            display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;
        }

        .sun-mascot-small { 
            width: 60px; height: 60px; animation: spin-slow 16s linear infinite; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1)); 
        }

        h1 {
            color: #FFF; 
            margin: 0; 
            font-size: 2.8rem;
            font-family: var(--font-main); 
            text-shadow: 3px 3px 0px #4A90E2, 5px 5px 5px rgba(0,0,0,0.2); 
            letter-spacing: 2px; 
            line-height: 1.2;
        }

        .status-bar {
            display: flex; align-items: stretch; justify-content: center; gap: 15px; width: 100%; max-width: 400px;
        }

        .star-widget {
            flex: 1; background: var(--ghibli-sun); padding: 10px; border-radius: 20px;
            box-shadow: 0 4px 0 #D9CFA0, 0 5px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; border: 3px solid var(--ghibli-earth); color: #D35400;
        }
        
        .star-count-text { 
            font-family: var(--font-main); 
            font-weight: bold; 
            margin-left: 5px; 
        }

        .clock-widget {
            flex: 1; background: rgba(255, 255, 255, 0.9); padding: 5px; border-radius: 20px;
            box-shadow: 0 4px 0 rgba(139, 94, 60, 0.3), 0 5px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 3px solid var(--ghibli-earth);
        }

        .analog-clock { width: 70px; height: 70px; }
        
        .digital-time { 
            font-family: var(--font-main); 
            color: var(--text-dark); 
            font-size: 1rem; 
            margin-top: -5px; 
        }
        
        .hand { transform-origin: 50% 50%; stroke-linecap: round; }
        .hand-hour { stroke: #4A3B2F; stroke-width: 4; }
        .hand-min { stroke: #8B5E3C; stroke-width: 3; }
        .hand-sec { stroke: #D35400; stroke-width: 1.5; }

        .game-card {
            background: var(--ghibli-cream);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            padding: 25px 20px; border-radius: 25px; width: 100%; max-width: 450px;
            display: flex; flex-direction: column; align-items: center;
            border: 6px solid var(--ghibli-earth);
            box-shadow: 0 10px 0 rgba(139, 94, 60, 0.3), 0 15px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px; position: relative;
        }

        .level-content-wrapper {
            display: flex;
            flex-direction: row;
            align-items: center; 
            justify-content: center; 
            width: 100%;
            gap: 15px; 
            margin-bottom: 15px;
        }

        .level-sticker-container { 
            width: 140px; 
            height: 140px;
            flex-shrink: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 0; 
        }

        /* åœ–ç‰‡èˆ‡SVGé€šç”¨æ¨£å¼ */
        .svg-icon, 
        .level-sticker img, 
        .level-sticker-container img { 
            width: 100%; 
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            animation: bounce-gentle 3s infinite ease-in-out; 
            object-fit: contain;
        }
        
        .level-sticker { 
            font-size: 8.5rem; 
            line-height: 1; 
            filter: drop-shadow(0 6px 4px rgba(0,0,0,0.1)); 
            animation: bounce-gentle 3s infinite ease-in-out; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; 
        }
        
        .blue-bag { filter: hue-rotate(210deg) drop-shadow(0 6px 4px rgba(0,0,0,0.1)) !important; }

        .level-title { 
            font-size: 2.6rem; 
            color: var(--text-dark); 
            margin: 0; 
            text-align: center; 
            line-height: 1.1;
        }
        
        .progress-bar-wrap { 
            width: 100%; height: 30px; background: #F0F4F8; border-radius: 15px; 
            border: 4px solid var(--ghibli-earth); margin: 10px 0; overflow: hidden; 
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.1);
        }
        .progress-bar { 
            height: 100%; width: 100%; background: linear-gradient(to bottom, #A1D2EB, #8FBED8); 
            transition: width 1s linear, background 0.5s ease; 
            border-radius: 10px; border-right: 3px solid rgba(255,255,255,0.5);
        }
        
        .timer-text { font-family: var(--font-main); font-size: 1.6rem; color: #8D7B68; margin-bottom: 25px; white-space: pre-wrap; text-align: center; }

        .btn-go {
            width: 100%; 
            height: auto; 
            padding: 15px 0; 
            border-radius: 25px; 
            
            background: linear-gradient(to bottom, #D4A373 0%, #B38253 100%);
            border: 5px solid #8B5E3C; color: #FFFBE8; 
            font-family: var(--font-en); 
            font-size: 2.5rem; cursor: pointer;
            box-shadow: 0 10px 0 #6D4C41, 0 15px 20px rgba(0,0,0,0.3), inset 0 2px 3px rgba(255,255,255,0.3);
            transition: all 0.15s; display: flex; align-items: center; justify-content: center;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3); -webkit-user-select: none; user-select: none;
        }
        .btn-go:active { transform: translateY(10px) scale(0.98); box-shadow: 0 2px 0 #6D4C41, inset 0 5px 10px rgba(0,0,0,0.2); }

        .btn-go.finish {
            background: linear-gradient(to bottom, #87C158 0%, #6EA343 100%);
            border: 5px solid #557D36; 
            font-size: 0; 
            padding: 18px 0;
            box-shadow: 0 10px 0 #426628, 0 15px 20px rgba(0,0,0,0.2), inset 0 2px 3px rgba(255,255,255,0.3);
        }
        .btn-go.finish:active { transform: translateY(10px); box-shadow: 0 2px 0 #426628; }
        
        .btn-go.tomorrow-btn {
            background: linear-gradient(to bottom, #4FACFE 0%, #00F2FE 100%); 
            border: 5px solid #00C6FB;
            color: #FFF;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 10px 0 #009EC3, 0 15px 20px rgba(0,0,0,0.2);
        }
        .btn-go.tomorrow-btn:active {
            transform: translateY(10px);
            box-shadow: 0 2px 0 #009EC3;
        }
        
        .check-icon { width: 55px; height: 55px; fill: none; stroke: #FFFBE8; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3)); animation: pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .weekly-stats-card {
            width: 100%; max-width: 450px; background: #F4EBC1; border-radius: 15px; padding: 10px 20px;
            border: 4px solid #D9CFA0; margin-bottom: 10px; color: #D35400; font-size: 1.4rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 5px 0 rgba(0,0,0,0.1);
        }
        .weekly-stats-title { font-size: 1.1rem; color: #8B5E3C; }
        
        .weekly-stats-count { font-family: var(--font-main); font-weight: bold; font-size: 1.6rem; }

        .calendar-card {
            width: 100%; max-width: 450px; background: var(--ghibli-cream);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            border-radius: 25px; padding: 20px; border: 5px solid var(--ghibli-earth);
            box-shadow: 0 8px 0 rgba(139, 94, 60, 0.3), 0 15px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .calendar-header { text-align: center; font-size: 1.6rem; color: var(--text-dark); margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-day {
            aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.5); border-radius: 12px; 
            font-family: var(--font-main); 
            color: #A09383; font-size: 1.1rem;
            border: 2px solid transparent; position: relative;
        }
        .cal-day.done { background: var(--ghibli-sun); color: #D35400; border: 3px solid #D9CFA0; font-size: 1.2rem; box-shadow: 0 3px 0 #D9CFA0; transform: rotate(-2deg); font-weight: bold; }
        .cal-day.done::after { content: 'â­'; font-size: 0.6rem; position: absolute; bottom: 2px; right: 2px; }
        .cal-day.early { background: #FFD700; color: #FFFBE8; border: 3px solid #DAA520; box-shadow: 0 3px 0 #DAA520; transform: rotate(2deg); }
        .cal-day.today { border: 3px dashed var(--ghibli-sky); }

        .footer-tools { 
            width: 100%; max-width: 450px;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            margin-top: 10px; padding: 0 10px; gap: 10px;
        }
        
        .btn-reset { background: none; border: none; color: #8D7B68; text-decoration: underline; font-family: var(--font-main); cursor: pointer; font-size: 1rem;}
        
        /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .style-select {
            padding: 5px 10px;
            border-radius: 10px;
            border: 2px solid #8B5E3C;
            background: #FFFBE8;
            color: #4A3B2F;
            font-family: var(--font-main);
            font-size: 0.9rem;
            cursor: pointer;
            width: 48%; /* è®“å…©å€‹é¸å–®ä¸¦æ’ */
        }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; display: none; }
        
        @keyframes bounce-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pop-in { 0% { transform: scale(0) rotate(-20deg); } 100% { transform: scale(1) rotate(0deg); } }
    </style>
</head>
<body>

    <header>
        <div class="header-top-row">
            <svg class="sun-mascot-small" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <g stroke="#FF9F43" stroke-width="8" stroke-linecap="round">
                    <line x1="50" y1="10" x2="50" y2="2"/> <line x1="50" y1="90" x2="50" y2="98"/>
                    <line x1="90" y1="50" x2="98" y2="50"/> <line x1="10" y1="50" x2="2" y2="50"/>
                    <line x1="78" y1="22" x2="84" y2="16"/> <line x1="22" y1="78" x2="16" y2="84"/>
                    <line x1="78" y1="78" x2="84" y2="84"/> <line x1="22" y1="22" x2="16" y2="16"/>
                </g>
                <circle cx="50" cy="50" r="30" fill="#FFD700" stroke="#FF9F43" stroke-width="3"/>
                <circle cx="40" cy="45" r="3" fill="#4A3B2F"/> <circle cx="60" cy="45" r="3" fill="#4A3B2F"/>
                <circle cx="35" cy="52" r="4" fill="#FF9A9E" opacity="0.8"/> <circle cx="65" cy="52" r="4" fill="#FF9A9E" opacity="0.8"/>
                <path d="M42 55 Q50 62 58 55" fill="none" stroke="#4A3B2F" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <h1>Good Morning</h1>
        </div>

        <div class="status-bar">
            <div class="star-widget">
                <span class="widget-icon">â­</span>
                <span class="star-count-text" id="stars-count">0</span>
            </div>
            
            <div class="clock-widget">
                <svg class="analog-clock" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#F4EBC1" stroke="#8B5E3C" stroke-width="3" />
                    <line x1="50" y1="10" x2="50" y2="15" stroke="#8B5E3C" stroke-width="2" />
                    <line x1="50" y1="90" x2="50" y2="85" stroke="#8B5E3C" stroke-width="2" />
                    <line x1="10" y1="50" x2="15" y2="50" stroke="#8B5E3C" stroke-width="2" />
                    <line x1="90" y1="50" x2="85" y2="50" stroke="#8B5E3C" stroke-width="2" />
                    <line id="hand-hour" class="hand hand-hour" x1="50" y1="50" x2="50" y2="25" />
                    <line id="hand-min" class="hand hand-min" x1="50" y1="50" x2="50" y2="15" />
                    <line id="hand-sec" class="hand hand-sec" x1="50" y1="50" x2="50" y2="12" />
                    <circle cx="50" cy="50" r="3" fill="#8B5E3C" />
                </svg>
                <div class="digital-time" id="digital-clock">--:--</div>
            </div>
        </div>
    </header>

    <div class="game-card">
        <div class="level-content-wrapper">
            <div class="level-sticker-container" id="level-icon-container">
                </div>
            <h2 class="level-title" id="level-name">å‚…æ—»èµ«! GOGO!</h2>
        </div>
        
        <div class="progress-bar-wrap" id="progress-wrap">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="timer-text" id="timer">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
        
        <button class="btn-go" id="action-btn" onclick="handleAction()">â–¶ï¸ GO</button>
    </div>

    <div class="weekly-stats-card">
        <span class="weekly-stats-title">æœ¬é€±æˆ°ç¸¾</span>
        <span class="weekly-stats-count" id="weekly-stars">0 â­</span>
    </div>

    <div class="calendar-card">
        <div class="calendar-header" id="cal-month-title">æœˆæ›†</div>
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <div class="footer-tools">
        <select id="font-selector" class="style-select">
            <option value="'ZCOOL KuaiLe', cursive">å¿«æ¨‚é«” (é è¨­)</option>
            <option value="'Zen Maru Gothic', sans-serif">åœ“åœ“é«” (Maru)</option>
            <option value="'Yomogi', cursive">éº¥å…‹ç­† (Yomogi)</option>
            <option value="'Potta One', cursive">è Ÿç­†é¢¨ (Potta)</option>
            <option value="'Dela Gothic One', cursive">æµ·å ±é¢¨ (Dela)</option>
        </select>

        <select id="voice-selector" class="style-select">
            <option value="cartoon">å¡é€š (å¿«é€Ÿ - æ¨è–¦)</option>
            <option value="energetic">æ´»åŠ›</option>
            <option value="normal">æ­£å¸¸ (åŸè²)</option>
            <option value="gentle">æº«æŸ” (æ…¢é€Ÿ)</option>
        </select>
        
        <div style="width: 100%; text-align: center; margin-top: 10px;">
            <button class="btn-reset" onclick="clearHistory()">é‡è¨­ç´€éŒ„</button>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <script>
        const checkIconSVG = `
        <svg class="check-icon" viewBox="0 0 24 24">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;

        const levels = [
            { name: "ä¸Šå»æ‰€", icon: "ğŸš½", type: "emoji", style: "" },
            { name: "åˆ·ç‰™", icon: "ğŸª¥", type: "emoji", style: "" },
            { name: "æ›è¡£æœ", icon: "ğŸ‘•", type: "emoji", style: "" },
            { name: "æ”¶æ›¸åŒ…", icon: "ğŸ’", type: "emoji", style: "blue-bag" }, 
            { 
                name: "è¥ªå­é‹å­", 
                icon: `<img src="foot.png" alt="Foot" style="height: 100%; width: auto;">`, 
                type: "html", 
                style: "" 
            },
            { 
                name: "å‡ºç™¼!", 
                icon: `<img src="go.png" alt="Go" style="height: 100%; width: auto;">`, 
                type: "html", 
                style: "" 
            } 
        ];

        let currentLevelIndex = 0;
        let isRunning = false;
        let startTime = 0;
        let timerInterval;
        let totalStars = 0; 
        let gameFinished = false;
        let failedTasks = []; // ç´€éŒ„è¶…æ™‚é …ç›®
        const TIME_LIMIT = 300; // 5åˆ†é˜é™åˆ¶

        const levelNameEl = document.getElementById('level-name');
        const levelIconContainer = document.getElementById('level-icon-container');
        const defaultSunEl = document.getElementById('default-sun');
        const timerEl = document.getElementById('timer');
        const progressBar = document.getElementById('progress-bar');
        const btnEl = document.getElementById('action-btn');
        const starsCountEl = document.getElementById('stars-count');
        const weeklyStarsEl = document.getElementById('weekly-stars');
        const calGrid = document.getElementById('calendar-grid');
        const calTitle = document.getElementById('cal-month-title');
        const fontSelector = document.getElementById('font-selector');
        const voiceSelector = document.getElementById('voice-selector');
        
        const handHour = document.getElementById('hand-hour');
        const handMin = document.getElementById('hand-min');
        const handSec = document.getElementById('hand-sec');
        const digitalClock = document.getElementById('digital-clock');

        // åˆå§‹åŒ–
        levelIconContainer.innerHTML = '<img src="sun.gif" alt="Sun" style="width: 100%; height: 100%; object-fit: contain;">';
        
        starsCountEl.textContent = 0;
        renderCalendar();
        renderWeeklyStats();
        updateClock(); 
        setInterval(updateClock, 1000);
        
        const savedFont = localStorage.getItem('beibei_font');
        if (savedFont) {
            document.documentElement.style.setProperty('--font-main', savedFont);
            fontSelector.value = savedFont;
        }

        const savedVoice = localStorage.getItem('beibei_voice');
        if (savedVoice) {
            voiceSelector.value = savedVoice;
        }

        fontSelector.addEventListener('change', (e) => {
            const newFont = e.target.value;
            document.documentElement.style.setProperty('--font-main', newFont);
            localStorage.setItem('beibei_font', newFont);
        });

        voiceSelector.addEventListener('change', (e) => {
            localStorage.setItem('beibei_voice', e.target.value);
        });

        function updateClock() {
            const now = new Date();
            const h = now.getHours(); const m = now.getMinutes(); const s = now.getSeconds();
            digitalClock.textContent = now.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute:'2-digit' });
            const secDeg = s * 6; const minDeg = m * 6 + s * 0.1; const hourDeg = (h % 12) * 30 + m * 0.5;
            handSec.style.transform = `rotate(${secDeg}deg)`;
            handMin.style.transform = `rotate(${minDeg}deg)`;
            handHour.style.transform = `rotate(${hourDeg}deg)`;
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{200D}ï¼š]/gu, '');
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'zh-TW'; 
                
                const voiceStyle = voiceSelector.value;
                if (voiceStyle === 'energetic') {
                    utterance.rate = 1.1; utterance.pitch = 1.2;
                } else if (voiceStyle === 'gentle') {
                    utterance.rate = 0.9; utterance.pitch = 1.0;
                } else if (voiceStyle === 'cartoon') {
                    utterance.rate = 1.2; utterance.pitch = 1.4;
                } else {
                    utterance.rate = 1.0; utterance.pitch = 1.0;
                }
                window.speechSynthesis.speak(utterance);
            }
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function updateStars(count) {
            totalStars += count;
            starsCountEl.textContent = totalStars;
            starsCountEl.parentElement.style.transform = "scale(1.2)";
            setTimeout(() => starsCountEl.parentElement.style.transform = "scale(1)", 300);
        }

        function handleAction() {
            if (gameFinished) { location.reload(); return; }
            if (!isRunning) { startLevel(); } else { finishLevelAndAutoStartNext(); }
        }

        function startLevel() {
            if (currentLevelIndex === 0) {
                totalStars = 0;
                failedTasks = [];
                starsCountEl.textContent = 0;
            }

            if (currentLevelIndex >= levels.length) return;
            isRunning = true;
            startTime = Date.now();
            const lvl = levels[currentLevelIndex];
            
            levelNameEl.textContent = lvl.name;
            
            // é¼“å‹µèªéŸ³
            const actionWords = ["é å‚™ï¼Œé–‹å§‹ï¼", "åŠ æ²¹åŠ æ²¹ï¼", "å‹•ä½œå¿«å–”ï¼", "GOGO!"];
            const randomWord = actionWords[Math.floor(Math.random() * actionWords.length)];
            speak(lvl.name + "ï¼Œ" + randomWord);

            if (lvl.type === 'html') {
                levelIconContainer.innerHTML = lvl.icon;
            } else {
                let className = "level-sticker";
                if (lvl.style) className += " " + lvl.style;
                levelIconContainer.innerHTML = `<div class="${className}">${lvl.icon}</div>`;
            }

            btnEl.innerHTML = checkIconSVG;
            btnEl.classList.add('finish');
            
            progressBar.style.width = '100%';
            progressBar.style.background = 'linear-gradient(to bottom, #A1D2EB, #8FBED8)';

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = TIME_LIMIT - elapsed;
                
                timerEl.textContent = formatTime(elapsed);
                const percentage = Math.max(0, (remaining / TIME_LIMIT) * 100);
                progressBar.style.width = percentage + '%';

                // ç´…ç¶ ç‡ˆé¡è‰²é‚è¼¯
                if (percentage > 50) {
                     progressBar.style.background = 'linear-gradient(to bottom, #A1D2EB, #8FBED8)'; // è—ç¶  (å®‰å…¨)
                } else if (percentage > 20) {
                     progressBar.style.background = 'linear-gradient(to bottom, #FFE066, #FFD700)'; // é»ƒè‰² (è­¦å‘Š)
                } else {
                     progressBar.style.background = 'linear-gradient(to bottom, #FF9AA2, #FFB7C5)'; // ç´…è‰² (å±éšª)
                }

                if (elapsed > TIME_LIMIT) { 
                    timerEl.style.color = '#D35400';
                    // å–®é …è¶…æ™‚ï¼Œæ–‡å­—æ”¹æˆå“­å“­è‡‰
                    timerEl.textContent = formatTime(elapsed) + " ğŸ˜­"; 
                } else { 
                    timerEl.style.color = '#8D7B68'; 
                }
            }, 1000);
        }

        function finishLevelAndAutoStartNext() {
            clearInterval(timerInterval);
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            
            // è¦å‰‡ 1: å–®é …éœ€æ–¼ 5 åˆ†é˜ (300ç§’) å…§å®Œæˆ
            if (elapsedSeconds <= TIME_LIMIT) {
                // å®Œæˆçµ¦ 1 é¡†æ˜Ÿ
                updateStars(1);
            } else {
                // è¶…æ™‚ä¸çµ¦æ˜Ÿï¼Œä¸¦è¨˜éŒ„
                failedTasks.push(levels[currentLevelIndex].name);
            }

            currentLevelIndex++;
            if (currentLevelIndex < levels.length) { startLevel(); } else { endGame(); }
        }

        function endGame() {
            isRunning = false;
            gameFinished = true;
            const now = new Date();
            const deadline = new Date();
            deadline.setHours(6, 50, 0); 

            let leftContent = "";
            let rightContent = "";
            let isPerfect = false;
            let finalTitle = "";
            let finalVoice = "";

            // åˆ¤æ–·æ˜¯å¦è¶…é 6:50
            if (now > deadline) {
                // --- ç‹€æ…‹ï¼šå¤ªæ™šäº† (å¤±æ•—) ---
                totalStars = 0;
                starsCountEl.textContent = 0; // æ˜Ÿæ˜Ÿæ­¸é›¶
                
                finalTitle = "å¤ªæ™šå›‰...";
                finalVoice = "å“å‘€ï¼Œè¶…éæ™‚é–“äº†ï¼Œæ˜Ÿæ˜Ÿéƒ½ä¸è¦‹äº†ã€‚";

                // å·¦é‚Šï¼šå“­å“­è‡‰ (å› ç‚ºè¶…é6:50)
                leftContent = "ğŸ˜­";

                // å³é‚Šï¼šé¬§é˜åœ–ç¤º (å› ç‚ºæ•´é«”è¶…æ™‚)
                rightContent = `<span style="font-size: 3.5rem;">â°</span>`;
            } else {
                // --- ç‹€æ…‹ï¼šæº–æ™‚å®Œæˆ ---
                // å·¦é‚Šï¼šç¬‘ç¬‘è‡‰ (å› ç‚ºåœ¨6:50å‰)
                leftContent = "ğŸ˜Š";

                if (failedTasks.length === 0) {
                    // --- ç‹€æ…‹ï¼šå®Œç¾ (å…¨éƒ¨å–®é …ä¹Ÿéƒ½æˆåŠŸ) ---
                    totalStars = totalStars * 2; // æ˜Ÿæ˜ŸåŠ å€
                    isPerfect = true;
                    
                    finalTitle = "å¤ªæ£’äº†ï¼";
                    finalVoice = "å¤ªæ£’äº†ï¼å…¨éƒ¨å®Œæˆï¼Œæ˜Ÿæ˜Ÿè®Šå…©å€ï¼";
                    
                    // å³é‚Šï¼šç¦®ç‚® ğŸ‰
                    rightContent = "ğŸ‰";
                    
                    // ç‰¹æ•ˆ
                    startConfetti();
                } else {
                    // --- ç‹€æ…‹ï¼šæº–æ™‚ä½†æœ‰å–®é …å¤±æ•— ---
                    finalTitle = "å®Œæˆï¼";
                    finalVoice = "åšå®Œäº†ï¼ä½†æ˜¯æœ‰å¹¾å€‹å‹•ä½œå¤ªæ…¢å›‰ï¼Œä½ çœ‹ç•«é¢ã€‚";

                    // å³é‚Šï¼šé¡¯ç¤ºå¤±æ•—é …ç›®çš„åœ–ç¤º
                    let failedIcons = failedTasks.map(taskName => {
                         const level = levels.find(l => l.name === taskName);
                         // åˆ¤æ–·æ˜¯ emoji é‚„æ˜¯ åœ–ç‰‡
                         if (level.type === 'emoji') {
                             return `<span style="font-size: 2.5rem; margin: 0 5px;">${level.icon}</span>`;
                         } else {
                             return `<div style="width: 40px; height: 40px; display:inline-block; margin: 0 5px;">${level.icon}</div>`;
                         }
                    }).join("");
                    
                    rightContent = `<div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center;">${failedIcons}</div>`;
                    
                    // é›–ç„¶ä¸æ˜¯å®Œç¾ï¼Œä½†å› ç‚ºå®Œæˆäº†ï¼Œçµ¦ä¸€é»é¼“å‹µç‰¹æ•ˆ
                    startConfetti();
                }
                starsCountEl.textContent = totalStars;
            }

            saveDailyRecord(totalStars, isPerfect);

            levelNameEl.textContent = finalTitle;
            speak(finalVoice);
            timerEl.style.display = 'none'; // éš±è—æ™‚é–“æ–‡å­—
            document.querySelector('.progress-bar-wrap').style.display = 'none';

            // çµ„åˆå·¦å³å…©é‚Šçš„ç•«é¢
            // ä½¿ç”¨ flexbox åˆ‡å‰²å·¦å³å…©å¡Šï¼Œä¸¦ç”¨ä¸­é–“ç·šéš”é–‹
            levelIconContainer.innerHTML = `
                <div style="display: flex; width: 100%; height: 100%; align-items: center;">
                    <div style="flex: 1; display: flex; justify-content: center; align-items: center; font-size: 5rem;">${leftContent}</div>
                    <div style="width: 3px; height: 70%; background: rgba(139, 94, 60, 0.3); border-radius: 2px;"></div>
                    <div style="flex: 1; display: flex; justify-content: center; align-items: center; font-size: 4rem;">${rightContent}</div>
                </div>
            `;
            
            // æŒ‰éˆ•æ”¹æˆæœˆäº®ç¬¦è™Ÿ
            btnEl.innerHTML = "ğŸŒ™"; 
            btnEl.style.fontSize = "3rem"; 
            
            btnEl.classList.remove('finish');
            btnEl.classList.add('tomorrow-btn'); 
        }

        function saveDailyRecord(stars, isPerfect) {
            const today = new Date();
            const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
            let calendarData = JSON.parse(localStorage.getItem('beibei_calendar') || "{}");
            calendarData[dateKey] = { done: true, stars: stars, early: isPerfect };
            localStorage.setItem('beibei_calendar', JSON.stringify(calendarData));
            renderCalendar();
            renderWeeklyStats();
        }

        function renderCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            calTitle.textContent = `${year}å¹´ ${month + 1}æœˆ`;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay();
            let calendarData = JSON.parse(localStorage.getItem('beibei_calendar') || "{}");
            let html = '';
            for (let i = 0; i < firstDayIndex; i++) html += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${month + 1}-${day}`;
                const record = calendarData[dateKey];
                const isToday = (day === now.getDate());
                let classes = 'cal-day';
                let content = day;
                if (isToday) classes += ' today';
                if (record) {
                    if (record.early) { classes += ' done early'; } 
                    else { classes += ' done'; }
                    content = record.stars || 'âœ“'; 
                }
                html += `<div class="${classes}">${content}</div>`;
            }
            calGrid.innerHTML = html;
        }

        function renderWeeklyStats() {
            let calendarData = JSON.parse(localStorage.getItem('beibei_calendar') || "{}");
            const now = new Date();
            const dayOfWeek = now.getDay(); 
            const diff = now.getDate() - dayOfWeek; 
            let weeklyTotal = 0;
            for (let i = 0; i < 7; i++) {
                let d = new Date(now);
                d.setDate(diff + i);
                const dateKey = `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
                if (calendarData[dateKey] && calendarData[dateKey].stars) {
                    weeklyTotal += calendarData[dateKey].stars;
                }
            }
            weeklyStarsEl.textContent = weeklyTotal + " â­";
        }

        function clearHistory() {
            if(confirm("è¦æ¸…é™¤æ‰€æœ‰æ˜Ÿæ˜Ÿå’Œæœˆæ›†è²¼ç´™å—ï¼Ÿ")) {
                localStorage.removeItem('beibei_calendar');
                localStorage.removeItem('beibei_total_stars');
                location.reload();
            }
        }

        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            canvas.style.display = 'block';
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const pieces = [];
            const colors = ['#A1D2EB', '#F4EBC1', '#87C158', '#FFD1DC'];
            for (let i = 0; i < 150; i++) {
                pieces.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 12 + 8,
                    speed: Math.random() * 4 + 2, 
                    rotation: Math.random() * 360
                });
            }
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(0, 0, p.size/2, 0, 2 * Math.PI); ctx.fill();
                    ctx.restore();
                    p.y += p.speed; p.rotation += p.speed * 1.5;
                    if (p.y > canvas.height) p.y = -20;
                });
                requestAnimationFrame(draw);
            }
            draw();
            setTimeout(() => canvas.style.display = 'none', 5000);
        }
    </script>
</body>
</html>
